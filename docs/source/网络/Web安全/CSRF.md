### CSRF
  1. 概要：
    * CSRF（Cross-site request forgery）跨站请求伪造，也被称为“One Click Attack”或者 Session Riding，通
常缩写为 CSRF 或者 XSRF，是一种对网站的恶意利用。

  2. 为什么浏览器要跨源？
    * 因为CSRF的存在，所有浏览器会有了同源策略

  3. CSRF
    * 尽管听起来像跨站脚本（XSS），但它与 XSS 非常不同，XSS 利用站点内的信任用户，而 CSRF 则通过伪装成受信任用户的请求来利用受信任的网站。
      1. 用户C打开浏览器，访问受信任网站A，输入用户名和密码请求登录网站A；
      2. 在用户信息通过验证后，网站A产生Cookie信息并返回给浏览器，此时用户登录网站A成功，可以正常发送请求到网站A；
      3. 用户未退出网站A之前，在同一浏览器中，打开一个TAB页访问网站B；
      4. 网站B接收到用户请求后，返回一些攻击性代码，并发出一个请求要求访问第三方站点A；
      5. 浏览器在接收到这些攻击性代码后，根据网站B的请求，在用户不知情的情况下携带Cookie信息，向网站A发出请求。网站A并不
      知道该请求其实是由B发起的，所以会根据用户C的Cookie信息以C的权限处理该请求，导致来自网站B的恶意代码被执行。(虽然同源策略避免了浏览器响应数据，但是数据还是发送到服务器去了)

  4. 点击劫持



  5. 危害
      1. 篡改目标网站上的用户数据信息；
      2. 盗取用户隐私数据；
      3. 配合XSS漏洞造成更大危害；
      4. 传播CSRF蠕虫。

  6. 存在地方
      1. 评论处
      2. 订阅处
      3. 资料修改处
      4. 密码更改处
      5. 管理员添加处
      6. 删除用户或者信息处

  7. CSRF漏洞的防御
      1. 尽量使用post请求
          GET接口太容易被拿来做CSRF攻击，只要构造一个img标签，而img标签又是不能过滤
          的数据。接口最好限制为POST使用，GET则无效，降低攻击风险。当然POST并不是万
          无一失，攻击者只要构造一个form就可以，但需要在第三方页面做，这样就增加暴露
          的可能性
      2. 添加验证码(对用户体验不太好)
      3. 验证Referer(效果不太高)
          但是这种办法的有效性不高，第一，可以抓包修改该字段；第二，在https跳转到
          http的情况下，浏览器出于安全考虑，不会发送referer，服务器就无法进行检查了，
          而且如果该网站同域的其他网站有XSS漏洞，那么攻击者可以在其他网站注入恶意脚本，
          受害者进入了此类同域的网址，也会遭受攻击。所以说有效性不高。（不靠谱的原因
          是服务器并不是随时都能获得Referer，只能监控是否发生，并且不能防范统一域上
          的CSRF攻击）
      4. 添加token,对token进行验证
          也就是发送请求时在HTTP请求中以参数的形式加入一个随机产生的token（一次性
          随机值），并在服务器建立一个拦截器来验证这个token。服务器读取浏览器当前
          域Cookie中这个token值，会进行校验该请求当中的token和Cookie当中的token值
          是否都存在且相等，当判断出存在且相等才认为这是合法的请求。否则认为这次
          请求是违法的，拒绝该次服务。
      5. 请求做二次确认
          比如黑客用CSRF让你转账，但是这个时候提示你——是否转账？，或者让你输入验证码
          什么的，提醒你的误操作，就可以有效防止CSRF
    
  8. XSS与CSRF的组合拳
      如果一个网站同时存在xss与csrf漏洞,那么攻击者就可以把csrf利用链接填入到存在xss漏洞的地方,从而增大攻击成功的可能性,一定程度上也可以绕过服务端对Referer的验证.


  9. CSRF token
      * 那么，可以考虑用一个 CSRF 攻击者无法利用的 token，来阻止攻击。
      1. 服务器后端除了为每个用户颁发用户凭证外，另外生成一个 token 给用户。只有同时持有用户凭证和该 token，才能确认是真正的用户。这就是 CSRF token，通常是攻击者无法预测的随机字符串。CSRF token 和用户凭证是绑定的，当随机的 CSRF token 和用户凭证被服务器判定不存在联系时，那就是有人在伪造用户身份。用户凭证存在于 cookie 中，但额外的 token 不通过 cookie 传递，而是在 HTML 页面中。
      2. 在只有 cookie 包含用户凭证的情况下，CSRF 就可以利用 cookie 冒充用户。但 CSRF 无法利用额外的 CSRF token。为什么呢？再想想 CSRF 的攻击方式，用户在恶意网站上，被迫向第三方网站 A 发送请求，虽然该请求携带用户 cookie，但却没有额外的 token，所以被服务器认为该请求是非法的。
      3. 为什么 CSRF 请求无法携带 CSRF token 呢？CSRF token，只能从网站 A 以第一方的方式获取。也就是 CSRF token 只存在于第一方的 HTML 页面中。而 CSRF 攻击，发生在第一方的恶意网站上，此时网站 A 作为第三方，根本就没有网站 A 的 HTML 页面，所以也就无法获取 CSRF token。












[参考文章1](https://catcat.cc/post/2020-06-23/)
[参考文章2](https://mp.weixin.qq.com/s/IR-GPGVcaKKm5XXslr0NgA)