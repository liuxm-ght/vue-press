###  DNS 
#### DNS
  1. 什么是DNS(Domain Name System )
      全称 Domain Name System ,即域名系统。

      万维网上作为域名和IP地址相互映射的一个分布式数据库，能够使用户更方便的访问互联网，而不用去记住能够被机器直接读取的IP数串。DNS协议运行在UDP协议之上，使用端口号53。

  2. DNS解析
      简单的说,通过域名,最终得到该域名对应的IP地址的过程叫做域名解析（或主机名解析）。
          www.zuofc.com (域名)  - DNS解析 -> 111.222.33.444 (IP地址)
  3. 简单理解DNS系统
      1. A记录
        Address记录，可以理解为域名与IP地址的映射，这些映射关系就是A记录。
        域名：www.baid.com ----> 111.111.111.111 // 只是假设
      2. CNAME(CNAME链)
        多个CNAME可以对应一个A记录的域名，举个例子：
        www.bai1.com ---> www.baidu.com
        www.bai2.com ---> www.baidu.com
        www.bai3.com ---> www.baidu.com
        <!-- 域名在解析过程中，可能直接被解析为IP地址，这种方式叫做域名解析的“A记录”；比如问路亭直接回复你，这个沃尔玛超市在xxx路xxx号。
        而另外一种情况是，域名会被解析成为另一个域名，这种方式叫做“别名”或者“CNAME记录”，例如问路亭发现，这个沃尔玛超市是由另外一个叫做沃尔爸超市代理的，则会继续查询沃尔爸超市的地理位置。
        域名的别名，也可以继续有别名，可能一层一层像链条一样传导下去，最终得到A记录及其IP地址。这个链条一般叫做“CNAME链”。（当然需要避免回环） -->

#### DNS缓存
  * 有dns的地方,就有缓存。浏览器、操作系统、Local DNS、根域名服务器，它们都会对DNS结果做一定程度的缓存。
  1. DNS查询过程如下:
      1. 浏览器DNS缓存：
        Network Process会先去浏览器DNS缓存中查找，有直接返回ip，没有则调用系统库函数进行查询
      2. 操作系统缓存：
        向操作系统中的Hosts文件查询，没有下一步
          <!-- 我们的操作系统会把域名查询结果在本机缓存一段时间，缓存多久也是LDNS告诉我们的（一般这个时间是100~300s之间）。 -->
      3. 本地DNS(LDNS)
        向本地DNS服务器(ISP服务器或者自己手动设置的DNS服务器)查询，没有下一步
          <!-- 当你在家接入宽带连接，或者手机连上3G/4G的时候，运营商都会帮你分配一个DNS服务器（这个DNS服务器对于你来可叫作本地DNS，或者local DNS，LDNS等）。 缓存的时间由权威服务器决定。-->
      * 上面3步是递归查询 ： 一路查下去中间不返回，得到最终结果才返回信息（浏览器到本地DNS服务器的过程）
      * 下面是迭代查询： 查询到一个返回，拿上一个结果去下一个查询
      4. 根DNS服务器(.域名)
        全球就13台，向其中一台查询，发现是.com.或.cn.，返回.com或.cn的域名服务器地址 给本地DNS服务器
      5. 顶级DNS服务器(TLD .com)
        本地DNS服务器继续向TLD查询，发现是a.com.,返回a.com的域名服务器地址 给本地DNS服务器
      6. 主DNS服务器(源服务器/权威服务器)
        本地DNS服务器继续向源服务器查询，返回最终ip地址 给本地DNS服务器，最终返回给浏览器，浏览器可以向ip访问了
        <!-- 而当DNS服务不知道域名解析的时候，它就会向权威服务器询问，如下图的过程。 -->
        <!-- 迭代流程：输入www.google.com网址后，首先在本地的域名服务器中查找，没找到去根域名服务器查找，没有再去com顶级域名服务器查找，，如此的类推下去，直到找到IP地址，然后把它记录在本地，供下次使用。大致过程就是.-> .com ->google.com. -> www.google.com.。 (你可能觉得我多写 .，并木有，这个.对应的就是根域名服务器，默认情况下所有的网址的最后一位都是.，既然是默认情况下，为了方便用户，通常都会省略，浏览器在请求DNS的时候会自动加上 -->
        <!-- 权威服务器的解释： https://juejin.cn/post/6990344840181940261 -->

  2. DNS负载均衡
    不知道你们有没有注意这样一件事，你访问baidu.com的时候，每次响应的并非是同一个服务器（IP地址不同），一般大公司都有成百上千台服务器来支撑访问，假设只有一个服务器，那它的性能和存储量要多大才能支撑这样大量的访问呢？DNS可以返回一个合适的机器的IP给用户，例如可以根据每台机器的负载量，该机器离用户地理位置的距离等等，这种过程就是DNS负载均衡

#### DNS预解析
  * 原理：当加载一个html时，会自动解析a标签的href链接为IP地址，并缓存。
    ```ts
      // index.html
      < html>
        <a href="test.baidu.com"></a>
      </>
    ```
    上面这段代码，当加载html文件时，会预先解析a标签href，并将IP缓存。当点击a标签时，就不需要DNS解析了。

  * 问题：HTTPS不会自动进行预解析。
    解决：需要手动添加在整个网站的入口页面。
    ```ts
      添加单条解析：
      < link rel="dns-prefetch" href="//img.alicdn.com"></>
      所有链接进行解析：
      < meta http-equiv="x-dns-prefetch-control" content="on">
    ```

### CDN 
#### CDN 
  1. 什么是CDN
    全称 Content Delivery Network,即 内容分发网络。
    <!-- 摘录一个形象的比喻,来理解CDN是什么。
      10年前，还没有火车票代售点一说，12306.cn更是无从说起。那时候火车票还只能在火车站的售票大厅购买，而我所在的小县城并不通火车，火车票都要去市里的火车站购买，而从我家到县城再到市里，来回就是4个小时车程，简直就是浪费生命。后来就好了，小县城里出现了火车票代售点，甚至乡镇上也有了代售点，可以直接在代售点购买火车票，方便了不少，全市人民再也不用在一个点苦逼的排队买票了。 -->
    <!-- 简单的理解CDN就是这些代售点(缓存服务器)的承包商,他为买票者提供了便利,帮助他们在最近的地方(最近的CDN节点)用最短的时间(最短的请求时间)买到票(拿到资源),这样去火车站售票大厅排队的人也就少了。也就减轻了售票大厅的压力(起到分流作用,减轻服务器负载压力)。
    用户在浏览网站的时候，CDN会选择一个离用户最近的CDN边缘节点来响应用户的请求，这样海南移动用户的请求就不会千里迢迢跑到北京电信机房的服务器（假设源站部署在北京电信机房）上了。 -->
  2. 可以理解为沃尔玛的代理仓库，沃尔玛总部运来的货物都存这(当然这也可以存别的华润万家的货物)，当用户想要去沃尔玛买东西，发现当地沃尔玛没货，那么当地沃尔玛会去代理仓库找，找到返回，没有去总部(源服务)找。
  3. 本地DNS系统(LDNS)没找到对应的ip，会去权威服务器申请，拿到CDN边缘节点的ip，本地DNS系统(LDNS)会去CDN找，找到返回，没找到去源服务找。

  * 浏览器缓存是提升再次访问速度，CDN是提升初次访问速度

#### CDN缓存
  1. 关于CDN缓存,在浏览器本地缓存失效后,浏览器会向CDN边缘节点发起请求。
    * 类似浏览器缓存,CDN边缘节点也存在着一套缓存机制。CDN边缘节点缓存策略因服务商不同而不同，但一般都会遵循http标准协议，通过http响应头中的
      Cache-control: max-age   //后面会提到
    的字段来设置CDN边缘节点数据缓存时间。
  2. 当浏览器向CDN节点请求数据时，CDN节点会判断缓存数据是否过期，若缓存数据并没有过期，则直接将缓存数据返回给客户端；否则，CDN节点就会向服务器发出回源请求，从服务器拉取最新数据，更新本地缓存，并将最新数据返回给客户端。 CDN服务商一般会提供基于文件后缀、目录多个维度来指定CDN缓存时间，为用户提供更精细化的缓存管理。

  3. CDN 优势
    1. 提升网页首次加载速度
    2. CDN节点解决了跨运营商和跨地域访问的问题，访问延时大大降低。
    3. 大部分请求在CDN边缘节点完成，CDN起到了分流作用，减轻了源服务器的负载。
    4. 使你的网站免于DDoS（拒绝服务）的攻击
  <!-- 缓存的刷新和预取，是CDN提供的相关功能。刷新就意味着主动抛弃CDN节点上的缓存内容（类似于，沃尔玛突然发现这批鸡蛋有问题，需要马上全部丢掉）；而预取就意味着，在没有外部访问的时候，提前把内容缓存到所有CDN节点上（类似于，让每个连锁店都提前从主站进一次货，防止需要的时候没有货）。 -->

  <!-- 链接：https://juejin.cn/post/6855469171703185416 -->

### DNS和CDN的整体流程
  1. 首先浏览器会从自身的DNS缓存中查找。
  2. 浏览器会从操作系统的DNS中查找。
  3. 从计算机的host文件中查找。
  4. 请求本地域名服务器（如：阿里云域名供应商的服务器）。
  5. 发现你有配置CNAME，查找到对应的域名（如：sunkuangdong.com ---> sun.com），通知浏览器请求改为找到的域名（sun.com）。重复上面1~3步骤。
  6. 又请求本地域名服务器，发现有这个域名的对应配置(此处有根域名等迭代查询)，（如：sun.com ---> 111.111.111.111），然后将IP返回给浏览器。
  7. 浏览器得到了IP地址(实际上是CDN区域负载均衡服务器的地址,即边缘层节点地址)，继续请求，CDN会根据用户的IP地址，以及用户请求的内容URL，选择一台离用户近的负载均衡设备，告诉用户向这台设备发起请求。(本地DNS系统会将域名解析的权利给我们CDN专用的DNS服务器)
  8. 区域负载均衡设备(边缘层节点)会向全局负载均衡设备(中心层节点)返回一台缓存服务器的IP地址。
  9. 全局负载均衡设备会把IP地址返回给用户。
  10. 用户最后向缓存服务器发起请求，缓存服务器有就响应数据，没有向上级缓存服务器要，一直追朔到网站的源服务器将内容拉到本地。
  <!-- https://juejin.cn/post/6927199288086757384 -->
  <!-- 
    对《DNS与CDN缓存关系.jpg》图片的解说：
      需要进一步说明的是：
      第 1 步访问的是加速域名，而不是源站域名。
      第 3 步返回 CNAME 域名。
      第 5 步返回 CNAME 域名对应的 IP 地址，指向 CDN 边缘层节点。
      第 6 步请求的 URL （或者说 Referer ）仍为‘js.marshall.com/idx.html’。
      第 7 步请求中心层节点时，会带上第 6 步的 URL 作为参数。
      第 8 步通过查询配置数据得到源站域名，进而向源站发起请求。这里的业务服务器即为 CDN 的源站。简单起见，省略了从 DNS 服务器查询 A 记录的过程。
      在整个过程中，URL 的域名会变化，但是 URL 的路径不会变化。

      链接：https://www.jianshu.com/p/1e9c8ab4ba44 
  -->

##### DNS与CDN
  如果使用了CDN会导致DNS解析时间增长。

### VPN 概念
  那么我们通常听到另一个词汇，VPN（Virtual Private Network）又是什么呢？
  * 试想一下，如果全市范围内沃尔玛就只有一个超市，那么怎么让全市居民快速来到这里呢？
  没错，是超市巴士。VPN就类似于超市巴士，可以迅速的将访问者接入服务端附近的网络。
  VPN则是让客户端能够统一接入，而服务端并不需要知道客户端在哪里，只要知道他们被拉近了，这也叫正向代理。
  <!-- https://zhuanlan.zhihu.com/p/26879931 -->

#### CDN与VPN显然是有区别的。
  1. CDN的作用是将服务端的体验做得更好，而客户端并不需要知道服务端在哪里，是怎么做的，这也叫反向代理；
  2. VPN则是让客户端能够统一接入，而服务端并不需要知道客户端在哪里，只要知道他们被拉近了，这也叫正向代理。


